# (1) 파일 업로드 처리

## Chapter 21. 파일 업로드 방식
### 클라이언트 측 파일 업로드 처리 방식
* `<form>` 태그 이용
  * 브라우저 제한이 없어야 하는 상황에서 이용
  * 페이지 이동과 동시에 파일을 업로드하는 방식
  * `<iframe>` 태그를 이용하면 화면 이동없이 처리 가능
* Ajax 이용
  * 파일 업로드를 별도로 처리
  * `<input type='file'>` 태그를 이용하여 처리
  * HTML5 및 제이쿼리를 이용하여 처리

### 서버 측 파일 업로드 처리 방식
* 서버에서 주의해야 할 점은 파일 처리를 위해 어떤 라이브러리/API 등을 활용하는지 결정하는 것
* 서버 측에서 처리하는 방식
  * cos.jar : 2002년 이후 개발 중지. 사용 지양
  * commons-fileupload : 일반적인 라이브러리. 서블릿 3.0 버전 이하에서도 사용 가능
  * 서블릿 버전 3.0 이상부터는 업로드 처리를 위한 API 제공

### 예제 코드
* 파일 업로드 관련 설정
  * web.xml
    * 서블릿 API 설정
    * 요청으로 들어온 파일 데이터를 임시 저장할 디렉터리 설정
  * servlet-context.xml
    * 스프링에서의 업로드 처리를 위한 설정
    * multipartResolver 이름의 빈 객체 등록
* 컨트롤러
  * POST 에서 임시 파일에 저장된 파일들을 처리 필요
    * MultipartFile 객체를 이용하여 요청으로 온 파일 데이터 접근
    * 현재는 /home/yjchoi/local-tmp/ 하위 폴더에 데이터 저장
  * GET 에서는 두 가지 방식으로 구현한 jsp 파일 연결
    * form 태그의 action 속성을 이용한 요청
    * 자바스크립트를 이용(fetch 및 FormData)


## Chapter 22. 파입 업로드 상세 처리
### 파일 업로드에서 고려해야 할 점
* 요청한 파일 데이터를 서버에서 저장하는 것 자체는 복잡하지 않음
* 저장 로직을 제외하고 추가적으로 고려해야 할 부분
  * 동일한 파일 이름에 대한 처리
  * 이미지의 경우, 크기가 커서 섬네일을 생성해야 하는 경우
  * 이미지 및 일반 파일을 구분하여 다운로드/페이지이동 등의 처리를 해야하는 경우
  * 파일을 이용한 공격을 대비하여 업로드 파일의 확장자 제한

### 예제 코드
* 파일 업로드 제한
  * 클라이언트 측에서 js로 처리
  * uploadAjax.jsp 에서 API 호출 이전에 파일 데이터 검증 처리
* 파일 저장시 고려할 부분 : uploadAjaxPost 메서드에 로직 추가
  * 중복된 이름
    * 타임스탬프(밀리세컨트)를 파일이름에 반영
    * UUID 이용
  * 하나의 폴더 내에 여러 파일 생성 방지
    * 일반적인 해결 방법은 '년/월/일' 단위로 폴더 생성
    * java.io.File 패키지의 mkdirs 이용하면 하위 폴더까지 생성 가능
* 이미지 파일과 일반 파일 구분 : uploadAjaxPost 메서드에 로직 추가
  * 이미지 파일의 경우, 섬네일 생성 로직 필요
    * thumbnailator 라이브러리 추가
    * 이미지 타입 확인을 위한 로직 추가
      * probeContentType 메서드를 이용하여 File MIME 타입 체크
      * image/vnd.microsoft.icon 형식은 이미지 변환에러가 발생하여 이미지로 처리 X
* 업로드 응답 변경 : uploadAjaxPost 메서드 반환 변경
  * 파일 업로드 응답을 위한 DTO 객체 설계
    * 업로드된 파일의 이름과 원본 파일 이름
    * 파일 저장 경로
    * 업로드 파일의 이미지 타입 여부
  * 응답 관련 코드 변경
    * @PostMapping 어노테이션의 produces 속성 추가
    * 응답 body 설정을 위한 @ResponseBody 추가


## Chapter 23. 클라이언트에서의 섬네일 처리
* 서버 Post API 응답에 대한 처리
  * 업로드 후 업로드 부분에 대한(input) 초기화 작업
  * 응답 데이터를 이용하여 섬네일이나 파일 이미지 보여주는 작업
* 썸네일 이미지의 경우 GET API 추가 : getFile 메서드
  * 특정 파일에 대한 이미지 바이너리 데이터 응답
  * 바이너리 타입의 응답 데이터이기 때문에 MIME 타입을 응답 헤더를 통해 설정


## Chapter 24. 첨부 파일 다운로드 or 원본 보여주기
###업로드 처리에 대한 사용자(클라이언트)의 사용 방식
* 이미지의 경우, 원본 파일을 보여주는 형태로 처리
  * light-box(라이트박스) 형식으로 처리
  * 모달 창의 일종
  * 브라우저에서 새로운 div 등을 생성하여 원본 이미지를 보여주는 방식
* 이미지가 아닌 경우, 기본적인 처리는 다운로드
  * 사용자가 특정 파일을 선택하면 다운로드 실행
  * 서버 측에서는 해당 파일의 MIME 타입을 헤더에 설정 및 다운로드 시 파일 이름 설정
    * Content-Type 헤더를 통해 MIME 타입 설정
    * Content-Disposition 헤더를 통해 다운로드 시 이름 설정

### 구현 코드
* 파일 다운로드 : UploadController.downloadFile 메서드
  * GET 관련 어노테이션의 produces 속성을 APPLICATION_OCTET_STREAM_VALUE 으로 설정
  * 응답 Body 객체로 `org.springframework.core.io.Resource` 설정
    * byte[] 보다 간단하게 처리하기 위함
    * 스프링에서 제공하는 Resource 객체를 이용하면 응답 객체를 만들기 쉬움
* 파일 다운로드에 대한 IE/Edge 브라우저 처리
  * Chrome 브라우저와 달리 파일 이름이 한글이 아닌 경우 이름이 깨지는 현상
  * User-Agent 요청 헤더를 통해 따로 처리 필요
  * RequestHeader 어노테이션을 이용하여 매개변수에 헤더 관련 파라미터 적용
* 원본 이미지 보여주기 처리 i.e 라이트박스 처리
  * 이미지를 서버에서 응답받아 화면에 보여주는 방식은 응답에 대한 썸네일을 보여주는 로직과 동일
  * 화면에 보여주기 위해 동적으로(by Javascript) 처리하는 것이 중요
  * 라이트박스 처리를 위해 제이쿼리 이용
* 삭제 처리
  * 삭제는 POST 요청의 body에 삭제 데이터 요청
  * 삭제 요청 관련 DTO 클래스 추가